<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Loan Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: #121212;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #ffffff;
            font-weight: 700;
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .input-section {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #b0b0b0;
            font-weight: 500;
        }

        input, select {
            padding: 0.75rem;
            background: rgba(50, 50, 50, 0.7);
            border: none;
            border-radius: 12px;
            color: #e0e0e0;
            font-size: 1rem;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.5);
            transform: scale(1.02);
        }

        .downpayment-toggle, .investment-toggle {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .downpayment-toggle button, .investment-toggle button {
            flex: 1;
            padding: 0.5rem;
            background: rgba(50, 50, 50, 0.7);
            border: none;
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .downpayment-toggle button.active, .investment-toggle button.active {
            background: linear-gradient(135deg, #4a90e2, #357abd);
        }

        button.calculate {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button.calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .additional-costs {
            margin-top: 1.5rem;
        }

        .additional-costs h3 {
            color: #ffffff;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .cost-input {
            display: grid;
            grid-template-columns: 2fr 1fr 40px;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .cost-input input {
            width: 100%;
        }

        .add-cost-btn, .remove-cost-btn {
            padding: 0.5rem;
            background: rgba(50, 50, 50, 0.7);
            border: none;
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .add-cost-btn:hover, .remove-cost-btn:hover {
            background: rgba(74, 144, 226, 0.7);
        }

        .results-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card h2 {
            margin-bottom: 1rem;
            color: #ffffff;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .metric-grid {
            display: grid;
            gap: 0.75rem;
        }

        .metric {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .metric:hover {
            background: rgba(50, 50, 50, 0.5);
        }

        .metric-label {
            color: #b0b0b0;
            font-size: 0.9rem;
            font-weight: 400;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: 500;
            text-align: right;
        }

        .metric-value.down-payment {
            color: #00f7ff;
        }

        .metric-value.interest-paid {
            color: #e74c3c;
        }

        .metric-value.positive {
            color: #2ecc71;
        }

        .metric-value.negative {
            color: #e74c3c;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background: rgba(50, 50, 50, 0.9);
            backdrop-filter: blur(8px);
            color: #e0e0e0;
            text-align: left;
            border-radius: 12px;
            padding: 12px;
            position: absolute;
            z-index: 1;
            bottom: 130%;
            right: 0;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        canvas {
            max-width: 100%;
            border-radius: 12px;
            background: rgba(20, 20, 20, 0.5);
            padding: 1rem;
        }

        .chart-legend {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        @media (max-width: 768px) {
            .results-section {
                grid-template-columns: 1fr;
            }
            .cost-input {
                grid-template-columns: 2fr 1fr;
                grid-template-rows: auto auto;
            }
            .remove-cost-btn {
                grid-column: 1 / 3;
                justify-self: center;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>
    <div class="container">
        <h1>Car Loan Visualizer</h1>
        
        <div class="input-section">
            <div class="input-grid">
                <div class="input-group">
                    <label for="loanPrice">Loan Price ($)</label>
                    <input type="number" id="loanPrice" value="50000" min="0" step="100">
                </div>
                <div class="input-group">
                    <label for="downPayment">Down Payment</label>
                    <input type="number" id="downPayment" value="10000" min="0" step="100">
                    <div class="downpayment-toggle">
                        <button class="active" onclick="toggleDownPayment('dollar')">Dollar ($)</button>
                        <button onclick="toggleDownPayment('percent')">Percent (%)</button>
                    </div>
                </div>
                <div class="input-group">
                    <label for="apr">APR (%)</label>
                    <input type="number" id="apr" value="5.5" min="0" step="0.1">
                </div>
                <div class="input-group">
                    <label for="loanTerm">Loan Term</label>
                    <select id="loanTerm">
                        <option value="12">12 months</option>
                        <option value="24">24 months</option>
                        <option value="36">36 months</option>
                        <option value="48">48 months</option>
                        <option value="60">60 months</option>
                        <option value="72" selected>72 months</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="monthlyPayment">Desired Monthly Payment ($)</label>
                    <input type="number" id="monthlyPayment" value="653.52" min="0" step="10">
                </div>
                <div class="input-group">
                    <label for="investmentAmount">Investment Amount ($)</label>
                    <input type="number" id="investmentAmount" value="4700.22" min="0" step="100">
                    <div class="investment-toggle">
                        <button class="active" onclick="toggleInvestmentGoal('interest')">Offset Interest</button>
                        <button onclick="toggleInvestmentGoal('car')">Pay Off Loan</button>
                    </div>
                </div>
                <div class="input-group">
                    <label for="spReturn">S&P 500 Expected Return (%)</label>
                    <input type="number" id="spReturn" value="7" min="0" step="0.1">
                </div>
            </div>
            <div class="additional-costs">
                <h3>Additional Costs</h3>
                <div id="costInputs"></div>
                <button class="add-cost-btn" onclick="addCostInput()">+ Add Cost</button>
            </div>
            <button class="calculate" onclick="calculate()">Calculate</button>
        </div>

        <div class="results-section">
            <div class="card">
                <h2>Loan Details</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <span class="metric-label">Loan Price</span>
                        <div class="metric-value tooltip" id="resultLoanPrice">$50,000.00
                            <span class="tooltiptext">Total price of the loan before down payment, including additional costs.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Down Payment</span>
                        <div class="metric-value down-payment tooltip" id="resultDownPayment">$10,000.00
                            <span class="tooltiptext">Initial payment made towards the loan.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Financed Amount</span>
                        <div class="metric-value tooltip" id="resultFinanced">$40,000.00
                            <span class="tooltiptext">Portion of loan price financed.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Monthly Payment</span>
                        <div class="metric-value tooltip" id="resultMonthly">$653.52
                            <span class="tooltiptext">Monthly payment for the loan.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Interest Paid</span>
                        <div class="metric-value interest-paid tooltip" id="resultInterest">$7,053.44
                            <span class="tooltiptext">Total interest paid over the loan term.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Net Value Impact</span>
                        <div class="metric-value tooltip" id="resultDownPaymentImpact">-$3,243.94
                            <span class="tooltiptext">Interest savings minus opportunity cost of investing the down payment.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ideal Down Payment</span>
                        <div class="metric-value tooltip" id="resultIdealDownPayment">$0.00
                            <span class="tooltiptext">Down payment maximizing cost-effectiveness with efficient monthly payment.</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Investment Analysis</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <span class="metric-label">S&P 500 Return Rate</span>
                        <div class="metric-value tooltip" id="resultSPRate">7.00%
                            <span class="tooltiptext">Expected annual return of S&P 500.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Amount Invested</span>
                        <div class="metric-value tooltip" id="resultInvested">$4,700.22
                            <span class="tooltiptext">Initial amount invested in S&P 500.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Investment Value</span>
                        <div class="metric-value tooltip" id="resultInvestment">$7,053.44
                            <span class="tooltiptext">Value of investment at loan term end.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Investment Gain</span>
                        <div class="metric-value tooltip" id="resultGain">$2,353.22
                            <span class="tooltiptext">Profit from investment.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Net Benefit of Financing</span>
                        <div class="metric-value tooltip" id="resultBenefit">$0.00
                            <span class="tooltiptext">Investment gain minus interest paid.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Initial Investment to Offset</span>
                        <div class="metric-value tooltip" id="resultOffsetInitial">$4,700.22
                            <span class="tooltiptext">Initial amount to offset interest.</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Monthly Investment to Offset</span>
                        <div class="metric-value tooltip" id="resultOffsetMonthly">$77.82
                            <span class="tooltiptext">Monthly amount to offset interest.</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Payment Breakdown</h2>
                <canvas id="paymentChart"></canvas>
            </div>
            <div class="card">
                <h2>Investment vs Interest</h2>
                <canvas id="investmentChart"></canvas>
            </div>
            <div class="card full-width">
                <h2>Down Payment Trade-Off</h2>
                <div class="chart-legend">Net Value Impact = Interest Savings - Opportunity Cost</div>
                <canvas id="downPaymentChart"></canvas>
            </div>
            <div class="card full-width">
                <h2>Monthly Payment vs. APR</h2>
                <canvas id="aprChart"></canvas>
            </div>
            <div class="card full-width">
                <h2>Monthly Payment vs. Loan Term</h2>
                <canvas id="termChart"></canvas>
            </div>
            <div class="card full-width">
                <h2>Total Interest Paid vs. Loan Term and APR</h2>
                <canvas id="interestChart"></canvas>
            </div>
            <div class="card full-width">
                <h2>Loan Progress Over Time</h2>
                <canvas id="progressChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        let paymentChart, investmentChart, downPaymentChart, aprChart, termChart, interestChart, progressChart;
        let downPaymentMode = 'dollar';
        let investmentGoal = 'interest';
        let customInvestmentSet = false;
        let customMonthlyPaymentSet = false;
        let customLoanPriceSet = false;

        function addCostInput(label = 'Cost', amount = 0) {
            const costInputs = document.getElementById('costInputs');
            const div = document.createElement('div');
            div.className = 'cost-input';
            div.innerHTML = `
                <input type="text" class="cost-label" value="${label}" placeholder="Cost Name">
                <input type="number" class="cost-amount" value="${amount}" min="0" step="10">
                <button class="remove-cost-btn" onclick="removeCostInput(this)">â€“</button>
            `;
            costInputs.appendChild(div);
        }

        function removeCostInput(button) {
            button.parentElement.remove();
            calculate();
        }

        function getAdditionalCosts() {
            const costInputs = document.querySelectorAll('.cost-amount');
            return Array.from(costInputs).reduce((sum, input) => {
                const value = parseFloat(input.value) || 0;
                return sum + (value >= 0 ? value : 0);
            }, 0);
        }

        function toggleDownPayment(mode) {
            downPaymentMode = mode;
            document.querySelectorAll('.downpayment-toggle button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(mode === 'dollar' ? 'Dollar' : 'Percent'));
            });
            const input = document.getElementById('downPayment');
            const loanPrice = parseFloat(document.getElementById('loanPrice').value) || 50000;
            input.value = mode === 'dollar' ? '10000' : '20';
            calculate();
        }

        function toggleInvestmentGoal(goal) {
            investmentGoal = goal;
            document.querySelectorAll('.investment-toggle button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(goal === 'interest' ? 'Interest' : 'Loan'));
            });
            customInvestmentSet = false;
            calculate();
        }

        function calculateLoanMetrics(totalLoanPrice, downPayment, apr, loanTerm) {
            const monthlyRate = apr / 12;
            const financedAmount = Math.max(0, totalLoanPrice - downPayment);
            const monthlyPayment = financedAmount * (monthlyRate * Math.pow(1 + monthlyRate, loanTerm)) /
                (Math.pow(1 + monthlyRate, loanTerm) - 1) || 0;
            const totalPaid = monthlyPayment * loanTerm;
            const totalInterest = totalPaid - financedAmount;
            return { financedAmount, monthlyPayment, totalInterest, totalPaid };
        }

        function calculate() {
            const loanPriceInput = document.getElementById('loanPrice');
            const monthlyPaymentInput = document.getElementById('monthlyPayment');
            const downPaymentInput = document.getElementById('downPayment');
            const aprInput = document.getElementById('apr');
            const loanTermInput = document.getElementById('loanTerm');
            const investmentInput = document.getElementById('investmentAmount');
            const spReturnInput = document.getElementById('spReturn');

            // Validate inputs
            let loanPrice = Math.max(0, parseFloat(loanPriceInput.value) || 50000);
            let downPaymentInputValue = Math.max(0, parseFloat(downPaymentInput.value) || 0);
            let apr = Math.max(0, parseFloat(aprInput.value) / 100 || 0.055);
            let loanTerm = Math.max(12, parseInt(loanTermInput.value) || 72);
            let desiredMonthlyPayment = Math.max(0, parseFloat(monthlyPaymentInput.value) || 0);
            let investmentAmount = Math.max(0, parseFloat(investmentInput.value) || 0);
            let spReturn = Math.max(0, parseFloat(spReturnInput.value) / 100 || 0.07);

            const additionalCosts = getAdditionalCosts();
            const totalLoanPrice = loanPrice + additionalCosts;

            // Handle down payment mode
            if (downPaymentMode === 'percent') {
                downPaymentInputValue = Math.min(downPaymentInputValue, 100);
                downPaymentInputValue = totalLoanPrice * (downPaymentInputValue / 100);
            }
            const downPayment = Math.min(downPaymentInputValue, totalLoanPrice);
            downPaymentInput.value = downPayment.toFixed(2);

            // Loan calculations
            const monthlyRate = apr / 12;
            let financedAmount = totalLoanPrice - downPayment;
            let monthlyPayment;

            // Handle loan price vs. monthly payment
            if (customMonthlyPaymentSet && desiredMonthlyPayment > 0) {
                const paymentFactor = (monthlyRate * Math.pow(1 + monthlyRate, loanTerm)) /
                    (Math.pow(1 + monthlyRate, loanTerm) - 1);
                financedAmount = desiredMonthlyPayment / paymentFactor;
                loanPrice = financedAmount + downPayment - additionalCosts;
                if (!customLoanPriceSet) {
                    loanPriceInput.value = loanPrice.toFixed(2);
                }
                monthlyPayment = desiredMonthlyPayment;
            } else {
                const metrics = calculateLoanMetrics(totalLoanPrice, downPayment, apr, loanTerm);
                financedAmount = metrics.financedAmount;
                monthlyPayment = metrics.monthlyPayment;
                if (!customMonthlyPaymentSet) {
                    monthlyPaymentInput.value = monthlyPayment.toFixed(2);
                }
            }

            // Update input handlers
            monthlyPaymentInput.onchange = () => {
                customMonthlyPaymentSet = true;
                customLoanPriceSet = false;
                calculate();
            };
            loanPriceInput.onchange = () => {
                customLoanPriceSet = true;
                customMonthlyPaymentSet = false;
                calculate();
            };
            loanTermInput.onchange = () => {
                customMonthlyPaymentSet = false;
                customLoanPriceSet = false;
                calculate();
            };
            aprInput.onchange = () => {
                customMonthlyPaymentSet = false;
                customLoanPriceSet = false;
                calculate();
            };
            downPaymentInput.onchange = () => {
                customMonthlyPaymentSet = false;
                customLoanPriceSet = false;
                calculate();
            };
            investmentInput.onchange = () => {
                customInvestmentSet = true;
                calculate();
            };
            spReturnInput.onchange = () => {
                calculate();
            };

            loanTermInput.value = loanTerm;
            const totalPaid = monthlyPayment * loanTerm;
            const totalInterest = totalPaid - financedAmount;

            // Down payment impact
            const baselineMetrics = calculateLoanMetrics(totalLoanPrice, 0, apr, loanTerm);
            const interestSavings = baselineMetrics.totalInterest - totalInterest;
            const opportunityCost = downPayment * (Math.pow(1 + spReturn, loanTerm / 12) - 1);
            const downPaymentImpact = interestSavings - opportunityCost;

            // Investment calculations
            if (!customInvestmentSet) {
                investmentAmount = investmentGoal === 'interest'
                    ? totalInterest / Math.pow(1 + spReturn, loanTerm / 12)
                    : totalLoanPrice / Math.pow(1 + spReturn, loanTerm / 12);
                investmentInput.value = investmentAmount.toFixed(2);
            }

            const investmentValue = investmentAmount * Math.pow(1 + spReturn, loanTerm / 12);
            const investmentGain = investmentValue - investmentAmount;
            const netBenefit = investmentGoal === 'interest'
                ? investmentGain - totalInterest
                : investmentGain - totalLoanPrice;

            const offsetTarget = investmentGoal === 'interest' ? totalInterest : totalLoanPrice;
            const initialOffsetInvestment = offsetTarget / Math.pow(1 + spReturn, loanTerm / 12);
            const monthlyOffsetInvestment = offsetTarget / ((Math.pow(1 + spReturn / 12, loanTerm) - 1) / (spReturn / 12));

            // Progress and trade-off data
            const progressData = calculateProgressData(financedAmount, monthlyPayment, monthlyRate, loanTerm, investmentAmount, spReturn);
            const downPaymentData = calculateDownPaymentTradeOff(totalLoanPrice, apr, loanTerm, spReturn, baselineMetrics);

            // APR, Term, and Interest data
            const aprData = calculateAPRData(totalLoanPrice, downPayment, loanTerm);
            const termData = calculateTermData(totalLoanPrice, downPayment, apr);
            const interestData = calculateInterestData(totalLoanPrice, downPayment, apr, loanTerm);

            // Update results
            document.getElementById('resultLoanPrice').textContent = `$${totalLoanPrice.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            document.getElementById('resultDownPayment').textContent = `$${downPayment.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            document.getElementById('resultFinanced').textContent = `$${financedAmount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            document.getElementById('resultMonthly').textContent = `$${monthlyPayment.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            document.getElementById('resultInterest').textContent = `$${totalInterest.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            document.getElementById('resultSPRate').textContent = `${(spReturn * 100).toFixed(2)}%`;
            document.getElementById('resultInvested').textContent = `$${investmentAmount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            document.getElementById('resultInvestment').textContent = `$${investmentValue.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            document.getElementById('resultOffsetInitial').textContent = `$${initialOffsetInvestment.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            document.getElementById('resultOffsetMonthly').textContent = `$${monthlyOffsetInvestment.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;

            const gainEl = document.getElementById('resultGain');
            gainEl.textContent = `$${investmentGain.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            gainEl.className = 'metric-value' + (investmentGain >= 0 ? ' positive' : ' negative');

            const benefitEl = document.getElementById('resultBenefit');
            benefitEl.textContent = `$${netBenefit.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            benefitEl.className = 'metric-value' + (netBenefit >= 0 ? ' positive' : ' negative');

            const impactEl = document.getElementById('resultDownPaymentImpact');
            impactEl.textContent = `$${downPaymentImpact.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
            impactEl.className = 'metric-value' + (downPaymentImpact >= 0 ? ' positive' : ' negative');

            const idealEl = document.getElementById('resultIdealDownPayment');
            idealEl.textContent = `$${downPaymentData.idealDownPayment.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')} (Monthly: $${downPaymentData.idealMonthlyPayment.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')})`;
            idealEl.className = 'metric-value';

            updateCharts(financedAmount, totalInterest, investmentAmount, investmentGain, progressData, downPaymentData, aprData, termData, interestData);
        }

        function calculateProgressData(financedAmount, monthlyPayment, monthlyRate, loanTerm, investmentAmount, spReturn) {
            const interestPaid = [];
            const principalRemaining = [];
            const investmentValues = [];
            const months = [];

            let remainingBalance = financedAmount;
            let totalInterestPaid = 0;

            for (let month = 0; month <= loanTerm; month++) {
                months.push(month);
                if (month > 0) {
                    const interestThisMonth = remainingBalance * monthlyRate;
                    totalInterestPaid += interestThisMonth;
                    const principalThisMonth = monthlyPayment - interestThisMonth;
                    remainingBalance -= principalThisMonth;
                }
                interestPaid.push(totalInterestPaid);
                principalRemaining.push(Math.max(0, remainingBalance));
                const investmentValue = investmentAmount * Math.pow(1 + spReturn, month / 12);
                investmentValues.push(investmentValue);
                if (remainingBalance <= 0) break;
            }

            return { months, interestPaid, principalRemaining, investmentValues };
        }

        function calculateDownPaymentTradeOff(totalLoanPrice, apr, loanTerm, spReturn, baselineMetrics) {
            const downPayments = [];
            const interestPaid = [];
            const opportunityCosts = [];
            const impacts = [];
            const monthlyPayments = [];
            const maxDownPayment = totalLoanPrice * 0.5;
            const step = maxDownPayment / 5;

            const baselineMonthlyPayment = baselineMetrics.monthlyPayment;
            const monthlyPaymentThreshold = baselineMonthlyPayment * 1.2; // Within 20% of baseline

            let idealDownPayment = 0;
            let idealMonthlyPayment = baselineMonthlyPayment;
            let maxImpact = -Infinity;

            for (let dp = 0; dp <= maxDownPayment; dp += step) {
                const metrics = calculateLoanMetrics(totalLoanPrice, dp, apr, loanTerm);
                downPayments.push(dp);
                interestPaid.push(metrics.totalInterest);
                monthlyPayments.push(metrics.monthlyPayment);
                const opportunityCost = dp * (Math.pow(1 + spReturn, loanTerm / 12) - 1);
                opportunityCosts.push(opportunityCost);
                const interestSavings = baselineMetrics.totalInterest - metrics.totalInterest;
                const impact = interestSavings - opportunityCost;
                impacts.push(impact);

                // Ideal down payment: max impact with monthly payment <= threshold
                if (impact > maxImpact && metrics.monthlyPayment <= monthlyPaymentThreshold) {
                    maxImpact = impact;
                    idealDownPayment = dp;
                    idealMonthlyPayment = metrics.monthlyPayment;
                }
            }

            return {
                downPayments,
                interestPaid,
                opportunityCosts,
                impacts,
                monthlyPayments,
                idealDownPayment,
                idealMonthlyPayment
            };
        }

        function calculateAPRData(totalLoanPrice, downPayment, loanTerm) {
            const aprs = [];
            const payments = [];
            for (let apr = 0.5; apr <= 10; apr += 0.5) { // Start at 0.5% to remove 0% APR
                const monthlyRate = (apr / 100) / 12;
                const financedAmount = totalLoanPrice - downPayment;
                const monthlyPayment = financedAmount * (monthlyRate * Math.pow(1 + monthlyRate, loanTerm)) /
                    (Math.pow(1 + monthlyRate, loanTerm) - 1) || 0;
                aprs.push(apr);
                payments.push(monthlyPayment);
            }
            return { aprs, payments };
        }

        function calculateTermData(totalLoanPrice, downPayment, apr) {
            const terms = [12, 24, 36, 48, 60, 72, 84];
            const payments = [];
            const monthlyRate = apr / 12;
            const financedAmount = totalLoanPrice - downPayment;
            for (let term of terms) {
                const monthlyPayment = financedAmount * (monthlyRate * Math.pow(1 + monthlyRate, term)) /
                    (Math.pow(1 + monthlyRate, term) - 1) || 0;
                payments.push(monthlyPayment);
            }
            return { terms, payments };
        }

        function calculateInterestData(totalLoanPrice, downPayment, apr, loanTerm) {
            // Interest vs. Term (fixed APR)
            const terms = [12, 24, 36, 48, 60, 72, 84];
            const interestVsTerm = [];
            const monthlyRate = apr / 12;
            const financedAmount = totalLoanPrice - downPayment;
            for (let term of terms) {
                const monthlyPayment = financedAmount * (monthlyRate * Math.pow(1 + monthlyRate, term)) /
                    (Math.pow(1 + monthlyRate, term) - 1) || 0;
                const totalPaid = monthlyPayment * term;
                const totalInterest = totalPaid - financedAmount;
                interestVsTerm.push(totalInterest);
            }

            // Interest vs. APR (fixed term)
            const aprs = [];
            const interestVsAPR = [];
            for (let aprPercent = 0.5; aprPercent <= 10; aprPercent += 0.5) {
                const monthlyRateAPR = (aprPercent / 100) / 12;
                const monthlyPayment = financedAmount * (monthlyRateAPR * Math.pow(1 + monthlyRateAPR, loanTerm)) /
                    (Math.pow(1 + monthlyRateAPR, loanTerm) - 1) || 0;
                const totalPaid = monthlyPayment * loanTerm;
                const totalInterest = totalPaid - financedAmount;
                aprs.push(aprPercent);
                interestVsAPR.push(totalInterest);
            }

            return { terms, interestVsTerm, aprs, interestVsAPR };
        }

        function updateCharts(financedAmount, totalInterest, investmentAmount, investmentGain, progressData, downPaymentData, aprData, termData, interestData) {
            if (paymentChart) paymentChart.destroy();
            paymentChart = new Chart(document.getElementById('paymentChart'), {
                type: 'pie',
                data: {
                    labels: ['Principal', 'Interest'],
                    datasets: [{
                        data: [financedAmount, totalInterest],
                        backgroundColor: ['#4a90e2', '#e74c3c'],
                        borderColor: '#2a2a2a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#e0e0e0' }
                        }
                    }
                }
            });

            if (investmentChart) investmentChart.destroy();
            investmentChart = new Chart(document.getElementById('investmentChart'), {
                type: 'bar',
                data: {
                    labels: ['Interest Paid', 'Investment'],
                    datasets: [
                        {
                            label: 'Interest Paid',
                            data: [totalInterest, 0],
                            backgroundColor: '#e74c3c',
                            borderColor: '#2a2a2a',
                            borderWidth: 2
                        },
                        {
                            label: 'Initial Investment',
                            data: [0, investmentAmount],
                            backgroundColor: '#4a90e2',
                            borderColor: '#2a2a2a',
                            borderWidth: 2
                        },
                        {
                            label: 'Investment Gain',
                            data: [0, investmentGain],
                            backgroundColor: '#2ecc71',
                            borderColor: '#2a2a2a',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3a3a' },
                            ticks: { color: '#e0e0e0' },
                            stacked: true
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#e0e0e0' },
                            stacked: true
                        }
                    }
                }
            });

            if (downPaymentChart) downPaymentChart.destroy();
            downPaymentChart = new Chart(document.getElementById('downPaymentChart'), {
                type: 'bar',
                data: {
                    labels: downPaymentData.downPayments.map(dp => `$${dp.toFixed(0).replace(/\d(?=(\d{3})+$)/g, '$&,')}`),
                    datasets: [
                        {
                            label: 'Interest Paid',
                            data: downPaymentData.interestPaid,
                            backgroundColor: '#e74c3c',
                            borderColor: '#2a2a2a',
                            borderWidth: 2
                        },
                        {
                            label: 'Opportunity Cost',
                            data: downPaymentData.opportunityCosts,
                            backgroundColor: '#f39c12',
                            borderColor: '#2a2a2a',
                            borderWidth: 2
                        },
                        {
                            label: 'Net Value Impact',
                            data: downPaymentData.impacts,
                            backgroundColor: downPaymentData.impacts.map(impact => impact >= 0 ? '#2ecc71' : '#e74c3c'),
                            borderColor: downPaymentData.downPayments.map((dp, i) => dp === downPaymentData.idealDownPayment ? '#00f7ff' : '#2a2a2a'),
                            borderWidth: downPaymentData.downPayments.map((dp, i) => dp === downPaymentData.idealDownPayment ? 4 : 2)
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const dp = downPaymentData.downPayments[index];
                                    const monthly = downPaymentData.monthlyPayments[index];
                                    const interest = downPaymentData.interestPaid[index];
                                    const oppCost = downPaymentData.opportunityCosts[index];
                                    const impact = downPaymentData.impacts[index];
                                    return [
                                        `Down Payment: $${dp.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`,
                                        `Monthly Payment: $${monthly.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`,
                                        `Interest Paid: $${interest.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`,
                                        `Opportunity Cost: $${oppCost.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`,
                                        `Net Value Impact: $${impact.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            display: context => context.dataset.label === 'Net Value Impact',
                            formatter: (value) => `$${value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`,
                            color: '#ffffff',
                            font: { weight: 'bold' },
                            anchor: 'end',
                            align: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3a3a' },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Amount ($)', color: '#e0e0e0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Down Payment ($)', color: '#e0e0e0' }
                        }
                    }
                }
            });

            if (aprChart) aprChart.destroy();
            aprChart = new Chart(document.getElementById('aprChart'), {
                type: 'line',
                data: {
                    labels: aprData.aprs.map(apr => `${apr.toFixed(1)}%`),
                    datasets: [{
                        label: 'Monthly Payment',
                        data: aprData.payments,
                        borderColor: '#4a90e2',
                        backgroundColor: '#4a90e2',
                        pointBackgroundColor: aprData.aprs.map(apr => apr === parseFloat(document.getElementById('apr').value) ? '#00f7ff' : '#4a90e2'),
                        pointBorderColor: aprData.aprs.map(apr => apr === parseFloat(document.getElementById('apr').value) ? '#00f7ff' : '#4a90e2'),
                        pointRadius: aprData.aprs.map(apr => apr === parseFloat(document.getElementById('apr').value) ? 6 : 3),
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const apr = aprData.aprs[index];
                                    const payment = aprData.payments[index];
                                    return `APR: ${apr.toFixed(1)}%, Monthly Payment: $${payment.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                                }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3a3a' },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Monthly Payment ($)', color: '#e0e0e0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'APR (%)', color: '#e0e0e0' }
                        }
                    }
                }
            });

            if (termChart) termChart.destroy();
            termChart = new Chart(document.getElementById('termChart'), {
                type: 'line',
                data: {
                    labels: termData.terms.map(term => `${term} mo`),
                    datasets: [{
                        label: 'Monthly Payment',
                        data: termData.payments,
                        borderColor: '#4a90e2',
                        backgroundColor: '#4a90e2',
                        pointBackgroundColor: termData.terms.map(term => term === parseInt(document.getElementById('loanTerm').value) ? '#00f7ff' : '#4a90e2'),
                        pointBorderColor: termData.terms.map(term => term === parseInt(document.getElementById('loanTerm').value) ? '#00f7ff' : '#4a90e2'),
                        pointRadius: termData.terms.map(term => term === parseInt(document.getElementById('loanTerm').value) ? 6 : 3),
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const term = termData.terms[index];
                                    const payment = termData.payments[index];
                                    return `Term: ${term} months, Monthly Payment: $${payment.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                                }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3a3a' },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Monthly Payment ($)', color: '#e0e0e0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Loan Term (Months)', color: '#e0e0e0' }
                        }
                    }
                }
            });

            if (interestChart) interestChart.destroy();
            interestChart = new Chart(document.getElementById('interestChart'), {
                type: 'line',
                data: {
                    labels: interestData.terms.map((_, i) => `${interestData.terms[i]} mo / ${interestData.aprs[i]}%`),
                    datasets: [
                        {
                            label: `Interest vs. Term (at ${(parseFloat(document.getElementById('apr').value) || 5.5).toFixed(1)}% APR)`,
                            data: interestData.interestVsTerm,
                            borderColor: '#e74c3c',
                            backgroundColor: '#e74c3c',
                            pointBackgroundColor: interestData.terms.map(term => term === parseInt(document.getElementById('loanTerm').value) ? '#00f7ff' : '#e74c3c'),
                            pointBorderColor: interestData.terms.map(term => term === parseInt(document.getElementById('loanTerm').value) ? '#00f7ff' : '#e74c3c'),
                            pointRadius: interestData.terms.map(term => term === parseInt(document.getElementById('loanTerm').value) ? 6 : 3),
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: `Interest vs. APR (at ${(parseInt(document.getElementById('loanTerm').value) || 72)} months)`,
                            data: interestData.interestVsAPR,
                            borderColor: '#f39c12',
                            backgroundColor: '#f39c12',
                            pointBackgroundColor: interestData.aprs.map(apr => apr === parseFloat(document.getElementById('apr').value) ? '#00f7ff' : '#f39c12'),
                            pointBorderColor: interestData.aprs.map(apr => apr === parseFloat(document.getElementById('apr').value) ? '#00f7ff' : '#f39c12'),
                            pointRadius: interestData.aprs.map(apr => apr === parseFloat(document.getElementById('apr').value) ? 6 : 3),
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const datasetLabel = context.dataset.label;
                                    if (datasetLabel.includes('Term')) {
                                        const index = context.dataIndex;
                                        const term = interestData.terms[index];
                                        const interest = interestData.interestVsTerm[index];
                                        return `Term: ${term} months, Interest Paid: $${interest.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                                    } else {
                                        const index = context.dataIndex;
                                        const apr = interestData.aprs[index];
                                        const interest = interestData.interestVsAPR[index];
                                        return `APR: ${apr.toFixed(1)}%, Interest Paid: $${interest.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                                    }
                                }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3a3a' },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Total Interest Paid ($)', color: '#e0e0e0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Loan Term (Months) / APR (%)', color: '#e0e0e0' }
                        }
                    }
                }
            });

            if (progressChart) progressChart.destroy();
            progressChart = new Chart(document.getElementById('progressChart'), {
                type: 'line',
                data: {
                    labels: progressData.months,
                    datasets: [
                        {
                            label: 'Interest Paid',
                            data: progressData.interestPaid,
                            borderColor: '#e74c3c',
                            backgroundColor: '#e74c3c',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Principal Remaining',
                            data: progressData.principalRemaining,
                            borderColor: '#4a90e2',
                            backgroundColor: '#4a90e2',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Investment Value',
                            data: progressData.investmentValues,
                            borderColor: '#2ecc71',
                            backgroundColor: '#2ecc71',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const month = progressData.months[index];
                                    const datasetLabel = context.dataset.label;
                                    const value = context.raw;
                                    return `${datasetLabel}: $${value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')} (Month ${month})`;
                                }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3a3a' },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Amount ($)', color: '#e0e0e0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#e0e0e0' },
                            title: { display: true, text: 'Months', color: '#e0e0e0' }
                        }
                    }
                }
            });
        }

        // Initialize with one cost input
        addCostInput('Taxes', 2000);
        calculate();
    </script>
</body>
</html>
